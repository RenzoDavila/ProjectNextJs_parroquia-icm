{"version":3,"sources":["../../../src/lib/db/postgres.ts"],"sourcesContent":["import { Pool, PoolClient, QueryResult, QueryResultRow } from 'pg';\n\n// Singleton pattern para la conexión a PostgreSQL\nlet pool: Pool | null = null;\n\n/**\n * Obtiene o crea una instancia del pool de conexiones a PostgreSQL\n */\nexport function getPool(): Pool {\n  if (!pool) {\n    pool = new Pool({\n      host: process.env.DB_HOST,\n      port: parseInt(process.env.DB_PORT || '5432'),\n      database: process.env.DB_NAME,\n      user: process.env.DB_USER,\n      password: process.env.DB_PASSWORD,\n      ssl: process.env.DB_SSL === 'true' ? { rejectUnauthorized: false } : false,\n      max: 20, // Máximo de conexiones en el pool\n      idleTimeoutMillis: 30000, // Tiempo antes de cerrar una conexión inactiva\n      connectionTimeoutMillis: 2000, // Tiempo máximo de espera para obtener una conexión\n    });\n\n    // Manejar errores del pool\n    pool.on('error', (err) => {\n      console.error('Error inesperado en el pool de PostgreSQL:', err);\n    });\n  }\n\n  return pool;\n}\n\n/**\n * Ejecuta una consulta SQL con parámetros\n */\nexport async function query<T extends QueryResultRow = any>(\n  text: string,\n  params?: any[]\n): Promise<QueryResult<T>> {\n  const pool = getPool();\n  const start = Date.now();\n  \n  try {\n    const result = await pool.query<T>(text, params);\n    const duration = Date.now() - start;\n    \n    // Log en desarrollo\n    if (process.env.NODE_ENV === 'development') {\n      console.log('Consulta ejecutada:', { text, duration, rows: result.rowCount });\n    }\n    \n    return result;\n  } catch (error) {\n    console.error('Error en consulta SQL:', error);\n    throw error;\n  }\n}\n\n/**\n * Obtiene una conexión del pool para ejecutar transacciones\n */\nexport async function getClient(): Promise<PoolClient> {\n  const pool = getPool();\n  return await pool.connect();\n}\n\n/**\n * Ejecuta una transacción\n */\nexport async function transaction<T>(\n  callback: (client: PoolClient) => Promise<T>\n): Promise<T> {\n  const client = await getClient();\n  \n  try {\n    await client.query('BEGIN');\n    const result = await callback(client);\n    await client.query('COMMIT');\n    return result;\n  } catch (error) {\n    await client.query('ROLLBACK');\n    throw error;\n  } finally {\n    client.release();\n  }\n}\n\n/**\n * Cierra el pool de conexiones (útil para testing o shutdown graceful)\n */\nexport async function closePool(): Promise<void> {\n  if (pool) {\n    await pool.end();\n    pool = null;\n  }\n}\n\n/**\n * Verifica si la conexión a la base de datos está funcionando\n */\nexport async function testConnection(): Promise<boolean> {\n  try {\n    const result = await query('SELECT NOW() as current_time');\n    console.log('Conexión a PostgreSQL exitosa:', result.rows[0]);\n    return true;\n  } catch (error) {\n    console.error('Error al conectar a PostgreSQL:', error);\n    return false;\n  }\n}\n\n// Tipos de utilidad para resultados de queries comunes\nexport interface DbResult<T> {\n  success: boolean;\n  data?: T;\n  error?: string;\n}\n\n/**\n * Helper para manejar errores de base de datos de forma consistente\n */\nexport function handleDbError(error: any): DbResult<never> {\n  console.error('Error de base de datos:', error);\n  \n  // Errores comunes de PostgreSQL\n  if (error.code === '23505') {\n    return { success: false, error: 'El registro ya existe (duplicado)' };\n  }\n  \n  if (error.code === '23503') {\n    return { success: false, error: 'Violación de clave foránea' };\n  }\n  \n  if (error.code === '23502') {\n    return { success: false, error: 'Campo obligatorio faltante' };\n  }\n  \n  return { \n    success: false, \n    error: process.env.NODE_ENV === 'development' \n      ? error.message \n      : 'Error al procesar la solicitud' \n  };\n}\n"],"names":[],"mappings":"4kCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,yCAGA,IAAI,EAAoB,KAKjB,SAAS,IAoBd,OAnBK,GAcH,CAbA,EADS,AACF,IAAI,EAAA,IAAI,CAAC,CACd,KAAM,QAAQ,GAAG,CAAC,OAAO,CACzB,KAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,EAAI,QACtC,SAAU,QAAQ,GAAG,CAAC,OAAO,CAC7B,KAAM,QAAQ,GAAG,CAAC,OAAO,CACzB,SAAU,QAAQ,GAAG,CAAC,WAAW,CACjC,IAA4B,SAAvB,QAAQ,GAAG,CAAC,MAAM,EAAc,CAAE,oBAAoB,CAAM,EACjE,EADqE,EAChE,GACL,kBAAmB,IACnB,wBAAyB,GAC3B,EAAA,EAGK,EAAE,CAAC,QAAU,AAAD,IACf,QAAQ,KAAK,CAAC,6CAA8C,EAC9D,GAGK,CACT,CAKO,eAAe,EACpB,CAAY,CACZ,CAAc,EAEd,IAAM,EAAO,IACC,KAAK,GAAG,GAEtB,GAAI,CACF,IAAM,EAAS,MAAM,EAAK,KAAK,CAAI,EAAM,GAQzC,OAPiB,KAAK,GAAG,GAOlB,CACT,CARgC,AAQ9B,MAAO,EAAO,CAEd,MADA,QAAQ,KAAK,CAAC,yBAA0B,GAClC,CACR,CACF,CAKO,eAAe,IACpB,IAAM,EAAO,IACb,OAAO,MAAM,EAAK,OAAO,EAC3B,CAKO,eAAe,EACpB,CAA4C,EAE5C,IAAM,EAAS,MAAM,IAErB,GAAI,CACF,MAAM,EAAO,KAAK,CAAC,SACnB,IAAM,EAAS,MAAM,EAAS,GAE9B,OADA,MAAM,EAAO,KAAK,CAAC,UACZ,CACT,CAAE,MAAO,EAAO,CAEd,MADA,MAAM,EAAO,KAAK,CAAC,YACb,CACR,QAAU,CACR,EAAO,OAAO,EAChB,CACF,CAoCO,SAAS,EAAc,CAAU,QAItC,CAHA,QAAQ,KAAK,CAAC,0BAA2B,GAGtB,SAAS,CAAxB,EAAM,IAAI,EACL,CAAE,SAAS,EAAO,MAAO,mCAAoC,EAGnD,SAAS,CAAxB,EAAM,IAAI,CACL,CAAE,SAAS,EAAO,MAAO,4BAA6B,EAG5C,SAAS,CAAxB,EAAM,IAAI,CACL,CAAE,SAAS,EAAO,MAAO,4BAA6B,EAGxD,CACL,SAAS,EACT,MAEI,CAFG,+BAGT,CACF,MAHQ"}