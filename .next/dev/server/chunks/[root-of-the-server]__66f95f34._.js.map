{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/davilaacostarenzojhair/DESARROLLO/Nyutku%20Systems/parroquia-icm-nextjs/src/lib/db/postgres.ts"],"sourcesContent":["import { Pool, PoolClient, QueryResult } from 'pg';\n\n// Singleton pattern para la conexión a PostgreSQL\nlet pool: Pool | null = null;\n\n/**\n * Obtiene o crea una instancia del pool de conexiones a PostgreSQL\n */\nexport function getPool(): Pool {\n  if (!pool) {\n    pool = new Pool({\n      host: process.env.DB_HOST,\n      port: parseInt(process.env.DB_PORT || '5432'),\n      database: process.env.DB_NAME,\n      user: process.env.DB_USER,\n      password: process.env.DB_PASSWORD,\n      ssl: process.env.DB_SSL === 'true' ? { rejectUnauthorized: false } : false,\n      max: 20, // Máximo de conexiones en el pool\n      idleTimeoutMillis: 30000, // Tiempo antes de cerrar una conexión inactiva\n      connectionTimeoutMillis: 2000, // Tiempo máximo de espera para obtener una conexión\n    });\n\n    // Manejar errores del pool\n    pool.on('error', (err) => {\n      console.error('Error inesperado en el pool de PostgreSQL:', err);\n    });\n  }\n\n  return pool;\n}\n\n/**\n * Ejecuta una consulta SQL con parámetros\n */\nexport async function query<T = any>(\n  text: string,\n  params?: any[]\n): Promise<QueryResult<T>> {\n  const pool = getPool();\n  const start = Date.now();\n  \n  try {\n    const result = await pool.query<T>(text, params);\n    const duration = Date.now() - start;\n    \n    // Log en desarrollo\n    if (process.env.NODE_ENV === 'development') {\n      console.log('Consulta ejecutada:', { text, duration, rows: result.rowCount });\n    }\n    \n    return result;\n  } catch (error) {\n    console.error('Error en consulta SQL:', error);\n    throw error;\n  }\n}\n\n/**\n * Obtiene una conexión del pool para ejecutar transacciones\n */\nexport async function getClient(): Promise<PoolClient> {\n  const pool = getPool();\n  return await pool.connect();\n}\n\n/**\n * Ejecuta una transacción\n */\nexport async function transaction<T>(\n  callback: (client: PoolClient) => Promise<T>\n): Promise<T> {\n  const client = await getClient();\n  \n  try {\n    await client.query('BEGIN');\n    const result = await callback(client);\n    await client.query('COMMIT');\n    return result;\n  } catch (error) {\n    await client.query('ROLLBACK');\n    throw error;\n  } finally {\n    client.release();\n  }\n}\n\n/**\n * Cierra el pool de conexiones (útil para testing o shutdown graceful)\n */\nexport async function closePool(): Promise<void> {\n  if (pool) {\n    await pool.end();\n    pool = null;\n  }\n}\n\n/**\n * Verifica si la conexión a la base de datos está funcionando\n */\nexport async function testConnection(): Promise<boolean> {\n  try {\n    const result = await query('SELECT NOW() as current_time');\n    console.log('Conexión a PostgreSQL exitosa:', result.rows[0]);\n    return true;\n  } catch (error) {\n    console.error('Error al conectar a PostgreSQL:', error);\n    return false;\n  }\n}\n\n// Tipos de utilidad para resultados de queries comunes\nexport interface DbResult<T> {\n  success: boolean;\n  data?: T;\n  error?: string;\n}\n\n/**\n * Helper para manejar errores de base de datos de forma consistente\n */\nexport function handleDbError(error: any): DbResult<never> {\n  console.error('Error de base de datos:', error);\n  \n  // Errores comunes de PostgreSQL\n  if (error.code === '23505') {\n    return { success: false, error: 'El registro ya existe (duplicado)' };\n  }\n  \n  if (error.code === '23503') {\n    return { success: false, error: 'Violación de clave foránea' };\n  }\n  \n  if (error.code === '23502') {\n    return { success: false, error: 'Campo obligatorio faltante' };\n  }\n  \n  return { \n    success: false, \n    error: process.env.NODE_ENV === 'development' \n      ? error.message \n      : 'Error al procesar la solicitud' \n  };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;;;;;AAEA,kDAAkD;AAClD,IAAI,OAAoB;AAKjB,SAAS;IACd,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,4GAAI,CAAC;YACd,MAAM,QAAQ,GAAG,CAAC,OAAO;YACzB,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;YACtC,UAAU,QAAQ,GAAG,CAAC,OAAO;YAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO;YACzB,UAAU,QAAQ,GAAG,CAAC,WAAW;YACjC,KAAK,QAAQ,GAAG,CAAC,MAAM,KAAK,SAAS;gBAAE,oBAAoB;YAAM,IAAI;YACrE,KAAK;YACL,mBAAmB;YACnB,yBAAyB;QAC3B;QAEA,2BAA2B;QAC3B,KAAK,EAAE,CAAC,SAAS,CAAC;YAChB,QAAQ,KAAK,CAAC,8CAA8C;QAC9D;IACF;IAEA,OAAO;AACT;AAKO,eAAe,MACpB,IAAY,EACZ,MAAc;IAEd,MAAM,OAAO;IACb,MAAM,QAAQ,KAAK,GAAG;IAEtB,IAAI;QACF,MAAM,SAAS,MAAM,KAAK,KAAK,CAAI,MAAM;QACzC,MAAM,WAAW,KAAK,GAAG,KAAK;QAE9B,oBAAoB;QACpB,wCAA4C;YAC1C,QAAQ,GAAG,CAAC,uBAAuB;gBAAE;gBAAM;gBAAU,MAAM,OAAO,QAAQ;YAAC;QAC7E;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,MAAM;IACR;AACF;AAKO,eAAe;IACpB,MAAM,OAAO;IACb,OAAO,MAAM,KAAK,OAAO;AAC3B;AAKO,eAAe,YACpB,QAA4C;IAE5C,MAAM,SAAS,MAAM;IAErB,IAAI;QACF,MAAM,OAAO,KAAK,CAAC;QACnB,MAAM,SAAS,MAAM,SAAS;QAC9B,MAAM,OAAO,KAAK,CAAC;QACnB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,MAAM,OAAO,KAAK,CAAC;QACnB,MAAM;IACR,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAKO,eAAe;IACpB,IAAI,MAAM;QACR,MAAM,KAAK,GAAG;QACd,OAAO;IACT;AACF;AAKO,eAAe;IACpB,IAAI;QACF,MAAM,SAAS,MAAM,MAAM;QAC3B,QAAQ,GAAG,CAAC,kCAAkC,OAAO,IAAI,CAAC,EAAE;QAC5D,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,OAAO;IACT;AACF;AAYO,SAAS,cAAc,KAAU;IACtC,QAAQ,KAAK,CAAC,2BAA2B;IAEzC,gCAAgC;IAChC,IAAI,MAAM,IAAI,KAAK,SAAS;QAC1B,OAAO;YAAE,SAAS;YAAO,OAAO;QAAoC;IACtE;IAEA,IAAI,MAAM,IAAI,KAAK,SAAS;QAC1B,OAAO;YAAE,SAAS;YAAO,OAAO;QAA6B;IAC/D;IAEA,IAAI,MAAM,IAAI,KAAK,SAAS;QAC1B,OAAO;YAAE,SAAS;YAAO,OAAO;QAA6B;IAC/D;IAEA,OAAO;QACL,SAAS;QACT,OAAO,uCACH,MAAM,OAAO,GACb;IACN;AACF"}},
    {"offset": {"line": 191, "column": 0}, "map": {"version":3,"sources":["file:///Users/davilaacostarenzojhair/DESARROLLO/Nyutku%20Systems/parroquia-icm-nextjs/src/app/api/admin/stats/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { query, handleDbError } from '@/lib/db/postgres';\n\n/**\n * GET /api/admin/stats\n * Obtiene estadísticas generales para el dashboard\n */\nexport async function GET() {\n  try {\n    // Estadísticas de reservas\n    const reservationsStats = await query<{ \n      total: string; \n      pending: string; \n      confirmed: string;\n      cancelled: string;\n      total_revenue: string;\n    }>(`\n      SELECT \n        COUNT(*) as total,\n        COUNT(*) FILTER (WHERE status = 'pending') as pending,\n        COUNT(*) FILTER (WHERE status = 'confirmed') as confirmed,\n        COUNT(*) FILTER (WHERE status = 'cancelled') as cancelled,\n        COALESCE(SUM(precio) FILTER (WHERE status = 'confirmed'), 0) as total_revenue\n      FROM mass_reservations\n    `);\n\n    // Reservas de hoy\n    const todayReservations = await query<{ count: string }>(`\n      SELECT COUNT(*) as count \n      FROM mass_reservations \n      WHERE reservation_date = CURRENT_DATE\n    `);\n\n    // Reservas de esta semana\n    const weekReservations = await query<{ count: string }>(`\n      SELECT COUNT(*) as count \n      FROM mass_reservations \n      WHERE reservation_date >= CURRENT_DATE - INTERVAL '7 days'\n    `);\n\n    // Mensajes no leídos\n    const unreadMessages = await query<{ count: string }>(`\n      SELECT COUNT(*) as count \n      FROM contact_messages \n      WHERE status = 'unread'\n    `);\n\n    // Total mensajes\n    const totalMessages = await query<{ count: string }>(`\n      SELECT COUNT(*) as count FROM contact_messages\n    `);\n\n    // Álbumes e imágenes\n    const albumsCount = await query<{ count: string }>(`\n      SELECT COUNT(*) as count FROM gallery_albums\n    `);\n\n    const imagesCount = await query<{ count: string }>(`\n      SELECT COUNT(*) as count FROM gallery_images\n    `);\n\n    // Equipo pastoral\n    const teamCount = await query<{ count: string }>(`\n      SELECT COUNT(*) as count FROM team_members\n    `);\n\n    // Grupos parroquiales\n    const groupsCount = await query<{ count: string }>(`\n      SELECT COUNT(*) as count FROM parish_groups\n    `);\n\n    // Banners\n    const bannersCount = await query<{ count: string }>(`\n      SELECT COUNT(*) as count FROM banners\n    `);\n\n    // Últimas 5 reservas\n    const recentReservations = await query(`\n      SELECT \n        mr.id, mr.nombre, mr.apellidos, mr.reservation_date, \n        mr.reservation_time, mr.tipo_misa, mr.status, mr.precio,\n        mt.nombre as tipo_misa_nombre\n      FROM mass_reservations mr\n      LEFT JOIN mass_types mt ON mr.tipo_misa = mt.tipo_misa\n      ORDER BY mr.created_at DESC\n      LIMIT 5\n    `);\n\n    // Reservas por tipo de misa (para gráfico)\n    const byMassType = await query<{ tipo_misa: string; nombre: string; count: string }>(`\n      SELECT \n        mr.tipo_misa, \n        mt.nombre,\n        COUNT(*) as count\n      FROM mass_reservations mr\n      LEFT JOIN mass_types mt ON mr.tipo_misa = mt.tipo_misa\n      GROUP BY mr.tipo_misa, mt.nombre\n      ORDER BY count DESC\n    `);\n\n    // Reservas por mes (últimos 6 meses)\n    const byMonth = await query<{ month: string; count: string }>(`\n      SELECT \n        TO_CHAR(reservation_date, 'YYYY-MM') as month,\n        COUNT(*) as count\n      FROM mass_reservations\n      WHERE reservation_date >= CURRENT_DATE - INTERVAL '6 months'\n      GROUP BY TO_CHAR(reservation_date, 'YYYY-MM')\n      ORDER BY month ASC\n    `);\n\n    const stats = reservationsStats.rows[0];\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        reservations: {\n          total: parseInt(stats.total),\n          pending: parseInt(stats.pending),\n          confirmed: parseInt(stats.confirmed),\n          cancelled: parseInt(stats.cancelled),\n          completed: 0,\n          totalRevenue: parseFloat(stats.total_revenue),\n          today: parseInt(todayReservations.rows[0].count),\n          thisWeek: parseInt(weekReservations.rows[0].count),\n        },\n        messages: {\n          total: parseInt(totalMessages.rows[0].count),\n          unread: parseInt(unreadMessages.rows[0].count),\n        },\n        gallery: {\n          albums: parseInt(albumsCount.rows[0].count),\n          images: parseInt(imagesCount.rows[0].count),\n        },\n        team: parseInt(teamCount.rows[0].count),\n        groups: parseInt(groupsCount.rows[0].count),\n        banners: parseInt(bannersCount.rows[0].count),\n        recentReservations: recentReservations.rows,\n        charts: {\n          byMassType: byMassType.rows.map(r => ({\n            type: r.tipo_misa,\n            name: r.nombre,\n            count: parseInt(r.count),\n          })),\n          byMonth: byMonth.rows.map(r => ({\n            month: r.month,\n            count: parseInt(r.count),\n          })),\n        },\n      },\n    });\n\n  } catch (error) {\n    console.error('Error al obtener estadísticas:', error);\n    const errorResult = handleDbError(error);\n    return NextResponse.json(\n      { success: false, error: errorResult.error },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}