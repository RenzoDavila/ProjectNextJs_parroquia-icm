{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/davilaacostarenzojhair/DESARROLLO/Nyutku%20Systems/parroquia-icm-nextjs/src/lib/db/postgres.ts"],"sourcesContent":["import { Pool, PoolClient, QueryResult } from 'pg';\n\n// Singleton pattern para la conexión a PostgreSQL\nlet pool: Pool | null = null;\n\n/**\n * Obtiene o crea una instancia del pool de conexiones a PostgreSQL\n */\nexport function getPool(): Pool {\n  if (!pool) {\n    pool = new Pool({\n      host: process.env.DB_HOST,\n      port: parseInt(process.env.DB_PORT || '5432'),\n      database: process.env.DB_NAME,\n      user: process.env.DB_USER,\n      password: process.env.DB_PASSWORD,\n      ssl: process.env.DB_SSL === 'true' ? { rejectUnauthorized: false } : false,\n      max: 20, // Máximo de conexiones en el pool\n      idleTimeoutMillis: 30000, // Tiempo antes de cerrar una conexión inactiva\n      connectionTimeoutMillis: 2000, // Tiempo máximo de espera para obtener una conexión\n    });\n\n    // Manejar errores del pool\n    pool.on('error', (err) => {\n      console.error('Error inesperado en el pool de PostgreSQL:', err);\n    });\n  }\n\n  return pool;\n}\n\n/**\n * Ejecuta una consulta SQL con parámetros\n */\nexport async function query<T = any>(\n  text: string,\n  params?: any[]\n): Promise<QueryResult<T>> {\n  const pool = getPool();\n  const start = Date.now();\n  \n  try {\n    const result = await pool.query<T>(text, params);\n    const duration = Date.now() - start;\n    \n    // Log en desarrollo\n    if (process.env.NODE_ENV === 'development') {\n      console.log('Consulta ejecutada:', { text, duration, rows: result.rowCount });\n    }\n    \n    return result;\n  } catch (error) {\n    console.error('Error en consulta SQL:', error);\n    throw error;\n  }\n}\n\n/**\n * Obtiene una conexión del pool para ejecutar transacciones\n */\nexport async function getClient(): Promise<PoolClient> {\n  const pool = getPool();\n  return await pool.connect();\n}\n\n/**\n * Ejecuta una transacción\n */\nexport async function transaction<T>(\n  callback: (client: PoolClient) => Promise<T>\n): Promise<T> {\n  const client = await getClient();\n  \n  try {\n    await client.query('BEGIN');\n    const result = await callback(client);\n    await client.query('COMMIT');\n    return result;\n  } catch (error) {\n    await client.query('ROLLBACK');\n    throw error;\n  } finally {\n    client.release();\n  }\n}\n\n/**\n * Cierra el pool de conexiones (útil para testing o shutdown graceful)\n */\nexport async function closePool(): Promise<void> {\n  if (pool) {\n    await pool.end();\n    pool = null;\n  }\n}\n\n/**\n * Verifica si la conexión a la base de datos está funcionando\n */\nexport async function testConnection(): Promise<boolean> {\n  try {\n    const result = await query('SELECT NOW() as current_time');\n    console.log('Conexión a PostgreSQL exitosa:', result.rows[0]);\n    return true;\n  } catch (error) {\n    console.error('Error al conectar a PostgreSQL:', error);\n    return false;\n  }\n}\n\n// Tipos de utilidad para resultados de queries comunes\nexport interface DbResult<T> {\n  success: boolean;\n  data?: T;\n  error?: string;\n}\n\n/**\n * Helper para manejar errores de base de datos de forma consistente\n */\nexport function handleDbError(error: any): DbResult<never> {\n  console.error('Error de base de datos:', error);\n  \n  // Errores comunes de PostgreSQL\n  if (error.code === '23505') {\n    return { success: false, error: 'El registro ya existe (duplicado)' };\n  }\n  \n  if (error.code === '23503') {\n    return { success: false, error: 'Violación de clave foránea' };\n  }\n  \n  if (error.code === '23502') {\n    return { success: false, error: 'Campo obligatorio faltante' };\n  }\n  \n  return { \n    success: false, \n    error: process.env.NODE_ENV === 'development' \n      ? error.message \n      : 'Error al procesar la solicitud' \n  };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;;;;;AAEA,kDAAkD;AAClD,IAAI,OAAoB;AAKjB,SAAS;IACd,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,4GAAI,CAAC;YACd,MAAM,QAAQ,GAAG,CAAC,OAAO;YACzB,MAAM,SAAS,QAAQ,GAAG,CAAC,OAAO,IAAI;YACtC,UAAU,QAAQ,GAAG,CAAC,OAAO;YAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO;YACzB,UAAU,QAAQ,GAAG,CAAC,WAAW;YACjC,KAAK,QAAQ,GAAG,CAAC,MAAM,KAAK,SAAS;gBAAE,oBAAoB;YAAM,IAAI;YACrE,KAAK;YACL,mBAAmB;YACnB,yBAAyB;QAC3B;QAEA,2BAA2B;QAC3B,KAAK,EAAE,CAAC,SAAS,CAAC;YAChB,QAAQ,KAAK,CAAC,8CAA8C;QAC9D;IACF;IAEA,OAAO;AACT;AAKO,eAAe,MACpB,IAAY,EACZ,MAAc;IAEd,MAAM,OAAO;IACb,MAAM,QAAQ,KAAK,GAAG;IAEtB,IAAI;QACF,MAAM,SAAS,MAAM,KAAK,KAAK,CAAI,MAAM;QACzC,MAAM,WAAW,KAAK,GAAG,KAAK;QAE9B,oBAAoB;QACpB,wCAA4C;YAC1C,QAAQ,GAAG,CAAC,uBAAuB;gBAAE;gBAAM;gBAAU,MAAM,OAAO,QAAQ;YAAC;QAC7E;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,MAAM;IACR;AACF;AAKO,eAAe;IACpB,MAAM,OAAO;IACb,OAAO,MAAM,KAAK,OAAO;AAC3B;AAKO,eAAe,YACpB,QAA4C;IAE5C,MAAM,SAAS,MAAM;IAErB,IAAI;QACF,MAAM,OAAO,KAAK,CAAC;QACnB,MAAM,SAAS,MAAM,SAAS;QAC9B,MAAM,OAAO,KAAK,CAAC;QACnB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,MAAM,OAAO,KAAK,CAAC;QACnB,MAAM;IACR,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAKO,eAAe;IACpB,IAAI,MAAM;QACR,MAAM,KAAK,GAAG;QACd,OAAO;IACT;AACF;AAKO,eAAe;IACpB,IAAI;QACF,MAAM,SAAS,MAAM,MAAM;QAC3B,QAAQ,GAAG,CAAC,kCAAkC,OAAO,IAAI,CAAC,EAAE;QAC5D,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,OAAO;IACT;AACF;AAYO,SAAS,cAAc,KAAU;IACtC,QAAQ,KAAK,CAAC,2BAA2B;IAEzC,gCAAgC;IAChC,IAAI,MAAM,IAAI,KAAK,SAAS;QAC1B,OAAO;YAAE,SAAS;YAAO,OAAO;QAAoC;IACtE;IAEA,IAAI,MAAM,IAAI,KAAK,SAAS;QAC1B,OAAO;YAAE,SAAS;YAAO,OAAO;QAA6B;IAC/D;IAEA,IAAI,MAAM,IAAI,KAAK,SAAS;QAC1B,OAAO;YAAE,SAAS;YAAO,OAAO;QAA6B;IAC/D;IAEA,OAAO;QACL,SAAS;QACT,OAAO,uCACH,MAAM,OAAO,GACb;IACN;AACF"}},
    {"offset": {"line": 191, "column": 0}, "map": {"version":3,"sources":["file:///Users/davilaacostarenzojhair/DESARROLLO/Nyutku%20Systems/parroquia-icm-nextjs/src/app/api/contact/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { query, handleDbError } from '@/lib/db/postgres';\nimport { headers } from 'next/headers';\n\ninterface ContactFormData {\n  name: string;\n  email: string;\n  phone?: string;\n  subject: string;\n  message: string;\n}\n\n/**\n * POST /api/contact\n * Envía un mensaje de contacto\n */\nexport async function POST(request: Request) {\n  try {\n    const body: ContactFormData = await request.json();\n    \n    // Validaciones básicas\n    if (!body.name || !body.email || !body.subject || !body.message) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Faltan campos obligatorios: nombre, email, asunto y mensaje',\n        },\n        { status: 400 }\n      );\n    }\n\n    // Validar formato de email\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    if (!emailRegex.test(body.email)) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'El formato del email no es válido',\n        },\n        { status: 400 }\n      );\n    }\n\n    // Obtener información del request\n    const headersList = await headers();\n    const ipAddress = headersList.get('x-forwarded-for') || \n                     headersList.get('x-real-ip') || \n                     'unknown';\n    const userAgent = headersList.get('user-agent') || 'unknown';\n\n    // Insertar mensaje en la base de datos\n    const result = await query(\n      `INSERT INTO contact_messages \n        (name, email, phone, subject, message, ip_address, user_agent, status)\n       VALUES ($1, $2, $3, $4, $5, $6, $7, 'unread')\n       RETURNING id, created_at`,\n      [\n        body.name.trim(),\n        body.email.trim().toLowerCase(),\n        body.phone?.trim() || null,\n        body.subject.trim(),\n        body.message.trim(),\n        ipAddress,\n        userAgent,\n      ]\n    );\n\n    const newMessage = result.rows[0];\n\n    return NextResponse.json({\n      success: true,\n      message: 'Mensaje enviado exitosamente. Nos pondremos en contacto contigo pronto.',\n      data: {\n        id: newMessage.id,\n        createdAt: newMessage.created_at,\n      },\n    });\n\n  } catch (error) {\n    console.error('Error al enviar mensaje de contacto:', error);\n    const errorResult = handleDbError(error);\n    \n    return NextResponse.json(\n      {\n        success: false,\n        error: errorResult.error || 'Error al enviar el mensaje',\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * GET /api/contact\n * Obtiene información de contacto de la parroquia\n */\nexport async function GET() {\n  try {\n    // Obtener configuración de contacto desde site_config\n    const result = await query(\n      `SELECT config_key, config_value \n       FROM site_config \n       WHERE config_key IN ('site_email', 'site_phone', 'site_whatsapp', 'site_address', 'site_city')\n       ORDER BY config_key`\n    );\n\n    const contactInfo: Record<string, string> = {};\n    result.rows.forEach(row => {\n      const key = row.config_key.replace('site_', '');\n      contactInfo[key] = row.config_value || '';\n    });\n\n    // Obtener redes sociales para contacto\n    const socialResult = await query(\n      `SELECT platform, platform_name, url, icon_name\n       FROM social_media\n       WHERE is_active = true\n       ORDER BY display_order ASC`\n    );\n\n    return NextResponse.json({\n      success: true,\n      contact: {\n        email: contactInfo.email || '',\n        phone: contactInfo.phone || '',\n        whatsapp: contactInfo.whatsapp || '',\n        address: contactInfo.address || '',\n        city: contactInfo.city || '',\n      },\n      socialMedia: socialResult.rows,\n    });\n\n  } catch (error) {\n    console.error('Error al obtener información de contacto:', error);\n    const errorResult = handleDbError(error);\n    \n    return NextResponse.json(\n      {\n        success: false,\n        error: errorResult.error || 'Error al obtener información de contacto',\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;;;;;AAcO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAwB,MAAM,QAAQ,IAAI;QAEhD,uBAAuB;QACvB,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC,KAAK,KAAK,IAAI,CAAC,KAAK,OAAO,IAAI,CAAC,KAAK,OAAO,EAAE;YAC/D,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,OAAO;YACT,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,2BAA2B;QAC3B,MAAM,aAAa;QACnB,IAAI,CAAC,WAAW,IAAI,CAAC,KAAK,KAAK,GAAG;YAChC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,OAAO;YACT,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,kCAAkC;QAClC,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,YAAY,YAAY,GAAG,CAAC,sBACjB,YAAY,GAAG,CAAC,gBAChB;QACjB,MAAM,YAAY,YAAY,GAAG,CAAC,iBAAiB;QAEnD,uCAAuC;QACvC,MAAM,SAAS,MAAM,IAAA,uIAAK,EACxB,CAAC;;;+BAGwB,CAAC,EAC1B;YACE,KAAK,IAAI,CAAC,IAAI;YACd,KAAK,KAAK,CAAC,IAAI,GAAG,WAAW;YAC7B,KAAK,KAAK,EAAE,UAAU;YACtB,KAAK,OAAO,CAAC,IAAI;YACjB,KAAK,OAAO,CAAC,IAAI;YACjB;YACA;SACD;QAGH,MAAM,aAAa,OAAO,IAAI,CAAC,EAAE;QAEjC,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;YACT,MAAM;gBACJ,IAAI,WAAW,EAAE;gBACjB,WAAW,WAAW,UAAU;YAClC;QACF;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,MAAM,cAAc,IAAA,+IAAa,EAAC;QAElC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO,YAAY,KAAK,IAAI;QAC9B,GACA;YAAE,QAAQ;QAAI;IAElB;AACF;AAMO,eAAe;IACpB,IAAI;QACF,sDAAsD;QACtD,MAAM,SAAS,MAAM,IAAA,uIAAK,EACxB,CAAC;;;0BAGmB,CAAC;QAGvB,MAAM,cAAsC,CAAC;QAC7C,OAAO,IAAI,CAAC,OAAO,CAAC,CAAA;YAClB,MAAM,MAAM,IAAI,UAAU,CAAC,OAAO,CAAC,SAAS;YAC5C,WAAW,CAAC,IAAI,GAAG,IAAI,YAAY,IAAI;QACzC;QAEA,uCAAuC;QACvC,MAAM,eAAe,MAAM,IAAA,uIAAK,EAC9B,CAAC;;;iCAG0B,CAAC;QAG9B,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;gBACP,OAAO,YAAY,KAAK,IAAI;gBAC5B,OAAO,YAAY,KAAK,IAAI;gBAC5B,UAAU,YAAY,QAAQ,IAAI;gBAClC,SAAS,YAAY,OAAO,IAAI;gBAChC,MAAM,YAAY,IAAI,IAAI;YAC5B;YACA,aAAa,aAAa,IAAI;QAChC;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6CAA6C;QAC3D,MAAM,cAAc,IAAA,+IAAa,EAAC;QAElC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO,YAAY,KAAK,IAAI;QAC9B,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}